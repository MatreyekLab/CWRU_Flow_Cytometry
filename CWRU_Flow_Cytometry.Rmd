---
title: "CWRU_Flow_Cytometry"
author: "Kenneth Matreyek"
date: "8/10/2020"
output: html_document
---

```{r Original setup, include=FALSE}
rm(list = ls())
library(tidyverse)
library(reshape)

attune_lasers <- data.frame("laser" = c("VL","BL","YL","RL"), "excitation" = c(405,488,561,638))
attune_detectors <- data.frame(
  "laser" = c(c("VL","VL","VL","VL"),c("BL","BL","BL"),c("YL","YL","YL","YL"),c("RL","RL","RL")),
  "mid" = c(c(440,512,603,710),c(530,590,695),c(585,620,695,780),c(670,720,780)),
  "band" = c(c(50,25,48,50),c(30,40,40),c(16,15,40,60),c(14,30,60)))
attune_detectors$min <- attune_detectors$mid - attune_detectors$band
attune_detectors$max <- attune_detectors$mid + attune_detectors$band
```

```{r}
attune_fp_table <- function(input_string){
  #input_string <- "mScarlet.I"
  #input_string <- "EGFP"
  #input_string <- "miRFP670"
  #input_string <- "mNeonGreen"
  #input_string <- "UnaG"
  fp_file_location <- paste("Spectra/",input_string,".csv", sep = "")
  excitation_name <- paste(input_string,".ex", sep = "")
  emission_name <- paste(input_string,".em", sep = "")
  
  fp <- read.csv(file = fp_file_location, header = T, stringsAsFactors = F)
  fp_excitation <- data.frame("laser" = attune_lasers$laser, "excitation" = attune_lasers$excitation)
  fp_excitation$efficiency <- 0
  for(x in 1:nrow(fp_excitation)){if(fp_excitation$excitation[x] %in% fp$wavelength){
    fp_excitation$efficiency[x] <- fp[fp$wavelength ==  fp_excitation$excitation[x],excitation_name]
    } else{fp_excitation$efficiency[x] <- 0}
  }
  
  fp_emission <- data.frame("laser" = attune_detectors$laser,"mid" = attune_detectors$mid)
  for(x in 1:nrow(fp_emission)){
    temp_vector <- fp[fp$wavelength >  attune_detectors[attune_detectors$mid == fp_emission$mid[x],"min"] & fp$wavelength < attune_detectors[attune_detectors$mid == fp_emission$mid[x],"max"],emission_name]
    temp_vector[is.na(temp_vector)] <- 0
    fp_emission$efficiency[x] <- sum(temp_vector)
  }
  
  fp_output <- data.frame(matrix(ncol = nrow(fp_excitation), nrow = nrow(fp_emission)))
  for(x in 1:ncol(fp_output)){
    for(y in 1:nrow(fp_output)){
      excitation_laser <- fp_excitation[x,"laser"]
      emission_laser <- fp_emission[y,"laser"]
      if(excitation_laser == emission_laser){
        excitation_efficiency <- fp_excitation[x,"efficiency"]
        emission_efficiency <- fp_emission[y,"efficiency"]
        efficiency_product <- excitation_efficiency * emission_efficiency
        fp_output[y,x] <- round(efficiency_product,2)
      } else{fp_output[y,x] <- 0}
    }
  }
  fp_output[is.na(fp_output)] <- 0
  colnames(fp_output) <- attune_lasers$laser
  rownames(fp_output) <- paste(attune_detectors$laser,"_",attune_detectors$mid,"/",attune_detectors$band,sep="")
  
  fp_output$detector <- rownames(fp_output)
  fp_output_melted <- melt(fp_output, id = "detector")
  
  fp_plot <- ggplot() + theme_bw() + 
    scale_fill_continuous(low = "white", high = "black") +
    ggtitle(input_string) +
    labs(x= NULL, y = NULL) +
    geom_tile(data = fp_output_melted, aes(x = variable, y = detector, fill = value))
  return(fp_plot)
}
```

```{r}
mScarlet_plot <- attune_fp_table("mScarlet.I")
ggsave(file = "Plots/mScarlet_plot.pdf", mScarlet_plot, height = 4, width = 3)

EGFP_plot <- attune_fp_table("EGFP")
ggsave(file = "Plots/EGFP_plot.pdf", EGFP_plot, height = 4, width = 3)

mCherry_plot <- attune_fp_table("mCherry")
ggsave(file = "Plots/mCherry_plot.pdf", mCherry_plot, height = 4, width = 3)

mTagBFP2_plot <- attune_fp_table("mTagBFP2")
ggsave(file = "Plots/mTagBFP2_plot.pdf", mTagBFP2_plot, height = 4, width = 3)

iRFP670_plot <- attune_fp_table("iRFP670")
ggsave(file = "Plots/iRFP670_plot.pdf", iRFP670_plot, height = 4, width = 3)

miRFP670_plot <- attune_fp_table("miRFP670")
ggsave(file = "Plots/miRFP670_plot.pdf", miRFP670_plot, height = 4, width = 3)

mNeonGreen_plot <- attune_fp_table("mNeonGreen")
ggsave(file = "Plots/mNeonGreen_plot.pdf", mNeonGreen_plot, height = 4, width = 3)

UnaG_plot <- attune_fp_table("UnaG")
ggsave(file = "Plots/UnaG_plot.pdf", UnaG_plot, height = 4, width = 3)

TDsmURFP_plot <- attune_fp_table("TDsmURFP")
ggsave(file = "Plots/TDsmURFP_plot.pdf", TDsmURFP_plot, height = 4, width = 3)

iRFP682_plot <- attune_fp_table("iRFP682")
ggsave(file = "Plots/iRFP682_plot.pdf", iRFP682_plot, height = 4, width = 3)

```
